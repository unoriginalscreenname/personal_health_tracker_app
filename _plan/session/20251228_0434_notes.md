# Session Notes - 2025-12-28 04:34

Fixed timezone bugs in date handling, added stats history feature with day detail view, and implemented dynamic streak calculation.

## What Was Done

### Timezone Bug Fixes
- Fixed `getToday()` and `getYesterday()` functions across all hooks to use local timezone instead of UTC
- Added `formatDateLocal()` helper function to `useDailyStats`, `useSupplements`, `useMealEntries`
- Fixed fasting compliance SQL query to use `strftime('%H', logged_at, 'localtime')` instead of UTC

### Stats History Feature
- Created `/stats` route with stack navigation (hidden from tab bar)
- `stats/index.tsx` - Lists all days with stats, shows fasting/supplements indicators
- `stats/[date].tsx` - Day detail view with:
  - Clickable date header with date picker modal
  - Prev/next day navigation arrows
  - Protein stats and food timeline
  - Supplements section with toggle functionality
  - Section headers showing success/failure indicators for fasting window and supplements

### Date Picker with Three Actions
- "Change to Date" (orange) - moves all data from current date to selected date
- "Go to Date" (blue) - navigates to view selected date without moving data
- "Cancel" (gray) - closes modal
- Validates target date doesn't already have data before allowing move

### Dynamic Streak Calculation
- Added `getCombinedStreak()` to `useDailyStats` - requires BOTH fasting AND supplements successful
- Returns `{ baseStreak, todayComplete }` for flexible display
- Streak = consecutive finalized days + 1 if today is also complete
- Today being incomplete doesn't break streak - just doesn't count yet
- Streak updates immediately when supplements are toggled on Command Center

### Database Functions
- Added `hasDataForDate(date)` - checks if any data exists for a date
- Added `moveDateData(fromDate, toDate)` - moves all meal entries, supplement logs, and daily stats
- Added `updateStatsForDate(date)` - recalculates stats for any date (finalized or not)
- Added `getCombinedStreak()` - combined fasting + supplements streak with today check
- Updated all supplement and meal entry hooks to call `updateStatsForDate(date)`

### UI Updates
- Made streak banner on Command Center clickable to navigate to stats
- Added "FASTING WINDOW" section header with success/failure indicator
- Updated "SUPPLEMENTS" section header with success/failure indicator

## Commits
- 4252c93 - Enhance tab navigation, stats screen, local timezone formatting
- 57cae6c - Date picker validation, section headers with indicators, stats updates
- 3606f82 - Combined streak logic, three-button date picker, immediate streak refresh

## Notes
- The `finalized` flag in daily_stats no longer prevents recalculation - stats update automatically on any data change
- Fasting compliance requires all meals between 12 PM - 6 PM local time; no meals = failure
- Supplements completion requires all at target except water (only needs 2/4)
- Streak requires BOTH fasting AND supplements to be successful for a day to count
